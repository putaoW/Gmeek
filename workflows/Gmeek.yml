name: build Gmeek

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  issues:
    types: [opened, edited]  # Issue è§¦å‘
  schedule:
    - cron: "0 16 * * *"  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤© UTC 16:00 = åŒ—äº¬æ—¶é—´ 00:00ï¼‰
    
jobs:
  build:
    name: Generate blog
    runs-on: ubuntu-24.04
    if: ${{ github.event.repository.owner.id == github.event.sender.id || github.event_name == 'schedule' }}
    permissions: write-all
    steps:
      - name: Checkout æœ¬ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆjq + æ„å»ºå·¥å…·ï¼‰
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          echo "====== æ£€æŸ¥æ ¸å¿ƒæ–‡ä»¶ ======"
          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          required_files=("Gmeek.py" "config.json" "requirements.txt" "templates/plist.html" "templates/post.html")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ç¼ºå¤±å¿…éœ€æ–‡ä»¶ï¼š$file"
              exit 1
            fi
          done
          echo "âœ… æ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶å­˜åœ¨"

      - name: é…ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: 3.8

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ç”Ÿæˆåšå®¢æ–‡ä»¶
        run: |
          echo "====== å¼€å§‹æ‰§è¡Œ Gmeek ç”Ÿæˆè„šæœ¬ ======"
          # å¤„ç† issue_numberï¼ˆä¸ºç©ºæ—¶ä¼ ç©ºå­—ç¬¦ä¸²ï¼‰
          ISSUE_NUM="${{ github.event.issue.number || '' }}"
          # æ‰§è¡Œæ ¸å¿ƒè„šæœ¬ï¼ˆä¼ å‚ï¼šgithub_tokenã€repo_nameã€--issue_numberï¼‰
          python Gmeek.py "${{ secrets.GITHUB_TOKEN }}" "${{ github.repository }}" --issue_number "$ISSUE_NUM"
          echo "====== è„šæœ¬æ‰§è¡Œå®Œæˆ ======"

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs  # éƒ¨ç½²ç›®å½•ï¼ˆä¸è„šæœ¬ä¸­ root_dir ä¸€è‡´ï¼‰
          publish_branch: gh-pages  # éƒ¨ç½²åˆ†æ”¯ï¼ˆé»˜è®¤ gh-pagesï¼‰
          force_orphan: true  # å¼ºåˆ¶è¦†ç›–æ—§éƒ¨ç½²ï¼ˆé¿å…å†²çªï¼‰
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"

      - name: è¾“å‡ºéƒ¨ç½²ç»“æœ
        run: |
          echo "ğŸ‰ åšå®¢éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“¦ éƒ¨ç½²ç›®å½•ï¼š./docs"
          echo "ğŸŒ è®¿é—®åœ°å€ï¼šhttps://${{ github.repository_owner }}.github.io/${{ github.repository_name }}"
